version: "3.1"

rules:

# ========================================
# ✅ CONVERSATION START (CRITICAL)
# ========================================
- rule: Conversation start
  conversation_start: true
  steps:
    - action: action_session_start

# ========================================
# ✅ GREET HANDLING - CHECK TERMS DYNAMICALLY
# ========================================
- rule: Handle all greet intents
  steps:
    - intent: greet
    - action: action_handle_greet

# ========================================
# ✅ SIMPLE SERVICES
# ========================================
- rule: Online billing
  steps:
    - intent: online_billing
    - action: action_check_terms_before_service
    - action: utter_billing_registration
    - action: utter_billing_registration1
    - action: action_show_carousel_extra

- rule: Payment option
  steps:
    - intent: payment_option
    - action: action_check_terms_before_service
    - action: utter_payment_option
    - action: action_show_carousel_extra

- rule: Requirements checklist
  steps:
    - intent: requirements_checklist
    - action: action_check_terms_before_service
    - action: utter_requirements_checklist
    - action: utter_requirements_checklist_2
    - action: action_show_carousel_extra

- rule: PMOS schedule
  steps:
    - intent: schedule_pmos
    - action: action_check_terms_before_service
    - action: utter_pmos_schedule
    - action: action_show_carousel_extra

- rule: Download forms
  steps:
    - intent: download_forms
    - action: action_check_terms_before_service
    - action: utter_downloadable_forms
    - action: action_show_carousel_extra

- rule: Contact info
  steps:
    - intent: contact_information
    - action: action_check_terms_before_service
    - action: utter_contact_information
    - action: utter_contact_information1
    - action: action_show_carousel_extra

- rule: Rates
  steps:
    - intent: rates
    - action: action_check_terms_before_service
    - action: utter_rates
    - action: action_show_carousel_extra

- rule: Office location
  steps:
    - intent: office_location
    - action: action_check_terms_before_service
    - action: utter_office_location
    - action: action_show_carousel_extra

- rule: Transfer of meter
  steps:
    - intent: transfer_of_meter
    - action: action_check_terms_before_service
    - action: utter_transfer_of_meter
    - action: utter_transfer_of_meter1
    - action: utter_transfer_of_meter2
    - action: utter_transfer_of_meter3
    - action: utter_transfer_of_meter4
    - action: action_show_carousel_extra

- rule: Energy saving tips
  steps:
    - intent: energy_saving_tips
    - action: action_check_terms_before_service
    - action: utter_energy_saving_tips
    - action: action_show_carousel_extra

- rule: Scheduled outage
  steps:
    - intent: schedule_outage
    - action: action_check_terms_before_service
    - action: utter_schedule_power_outage
    - action: action_show_carousel_extra

# ========================================
# ✅ FORM ACTIVATION (DETERMINISTIC)
# ========================================
- rule: Activate power outage form
  steps:
    - intent: report_power_outage
    - action: action_check_terms_before_form
    - action: power_outage_form
    - active_loop: power_outage_form

- rule: Submit power outage form
  condition:
    - active_loop: power_outage_form
  steps:
    - action: power_outage_form
    - active_loop: null
    - action: action_submit_power_outage_form
    - action: action_show_carousel_extra

- rule: Activate follow up report form
  steps:
    - intent: follow_up_report
    - action: action_check_terms_before_form
    - action: follow_up_report_form
    - active_loop: follow_up_report_form

- rule: Submit follow up report form
  condition:
    - active_loop: follow_up_report_form
  steps:
    - action: follow_up_report_form
    - active_loop: null
    - action: action_submit_follow_up_report_form
    - action: action_show_carousel_extra

- rule: Activate meter concern followup form
  steps:
    - intent: meter_concern_followup
    - action: action_check_terms_before_form
    - action: meter_concern_followup_form
    - active_loop: meter_concern_followup_form

- rule: Submit meter concern followup form
  condition:
    - active_loop: meter_concern_followup_form
  steps:
    - action: meter_concern_followup_form
    - active_loop: null
    - action: action_submit_meter_concern_followup
    - action: action_show_carousel_extra

- rule: Activate talk to agent form
  steps:
    - intent: talk_to_agent
    - action: action_check_terms_before_form
    - action: talk_to_agent_form
    - active_loop: talk_to_agent_form

- rule: Submit talk to agent form
  condition:
    - active_loop: talk_to_agent_form
  steps:
    - action: talk_to_agent_form
    - active_loop: null
    - action: action_submit_talk_to_agent_form

- rule: Activate meter concern form
  steps:
    - intent: meter_concern
    - action: action_check_terms_before_form
    - action: meter_concern_form
    - active_loop: meter_concern_form

- rule: Submit meter concern form
  condition:
    - active_loop: meter_concern_form
  steps:
    - action: meter_concern_form
    - active_loop: null
    - action: action_submit_meter_concern
    - action: action_show_carousel_extra

# ========================================
# ⚙️ FALLBACK
# ========================================
- rule: Out of scope
  steps:
    - intent: out_of_scope
    - action: action_default_fallback

- rule: NLU fallback
  steps:
    - intent: nlu_fallback
    - action: action_default_fallback

# ========================================
# ✅ TERMS ACCEPTANCE - SHOW CAROUSEL
# ========================================
- rule: Show carousel after accepting terms
  steps:
    - intent: accept_terms
    - action: action_accept_terms
    - action: utter_agree
    - action: action_show_carousel
  
# ========================================
# ✅ RESUME CONVERSATION AFTER AGENT QUEUE
# ========================================
- rule: Resume conversation after agent queue
  steps:
    - intent: resume_conversation
    - action: action_resume_conversation